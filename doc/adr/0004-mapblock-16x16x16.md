# ADR-0004: 16×16×16 node MapBlock chunk size

Date: 2011-01-01
Status: Accepted

## Context

Luanti's world is infinite in the X and Z axes and large in Y. Storing and
transmitting the world node-by-node would be impractical. The world must be
divided into fixed-size chunks ("MapBlocks") for:

- Memory management: load/unload regions of the world efficiently
- Network transfer: send only the blocks a client needs
- Lighting and mesh generation: recalculate only the affected region when a node changes
- Disk storage: serialize and index blocks as atomic units in the database backend

The chunk size is a fundamental constant that affects performance characteristics
across the entire engine. It must be chosen before the first stable world format
and cannot easily be changed afterward without breaking saved worlds.

## Decision

Each MapBlock contains exactly 16×16×16 = 4,096 nodes. MapBlock coordinates are
derived by dividing world node coordinates by 16 (arithmetic right shift). This size
is baked into the network protocol, database key format, and mesh generation pipeline.

## Consequences

**Positive:**
- 4,096 nodes fit comfortably in CPU cache when iterating; neighbouring blocks
  can be prefetched predictably
- A power-of-2 size enables fast coordinate arithmetic (bit shifts instead of division)
- Block boundaries align with typical build structures (16 matches Minecraft's chunk
  width, familiar to players)
- Small enough that individual block updates (lighting, mesh rebuild) complete in under
  a millisecond on modern hardware for most change types
- Network packets per block are reasonable in size (~a few KB compressed)

**Negative / trade-offs:**
- Small block size means more blocks to manage for large view distances (a 32-block
  radius view loads up to ~130K blocks)
- Each block has metadata overhead (header, lighting data, timestamp) that adds up
  at scale
- Block boundaries create seam artefacts in lighting and mesh generation that require
  careful handling of neighbour blocks

**Neutral / notes:**
- `MapBlock` is defined in `src/mapblock.h`
- Block positions use `v3s16` (signed 16-bit integers), giving a theoretical world size
  of ±512K blocks (~8 million nodes) per axis
- The block size constant `MAP_BLOCKSIZE = 16` is defined in `src/constants.h`
